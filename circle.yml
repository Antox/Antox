machine:
  timezone:
    Europe/Vienna
  java:
    version: oraclejdk8
  environment:
    ZEMU_: "appemu23"
    EMU_: "appemu21"
    XEMU_: "appemu10"
    Zsdpath: "/sdcard"
    sdpath: "/storage/sdcard"
    Xsdpath: "/mnt/sdcard"
    ANDROID_HOME: /usr/local/android-sdk-linux
    ANDROID_SDK: /usr/local/android-sdk-linux/
    _SDK_: /usr/local/android-sdk-linux/
    GRADLE_OPTS: '-Dorg.gradle.jvmargs="-Xmx1000m -XX:+HeapDumpOnOutOfMemoryError"'
    SBT_OPTS: "-Xms512M -Xmx1536M -Xss1M -XX:+CMSClassUnloadingEnabled -XX:MaxPermSize=256M"
    CLASS_P: chat.tox.antox
    START_INTENT_P: chat.tox.antox.activities.LoginActivity
    DEBIAN_FRONTEND: noninteractive
dependencies:
  cache_directories:
    - ~/.android
    - ~/.gradle
  override:
    - echo "dummy"
  pre:
    - sudo apt-get update > /dev/null 2> /dev/null
    - sudo apt-get install xvfb > /dev/null 2> /dev/null
    - sudo apt-get install xdotool > /dev/null 2> /dev/null
    - sudo apt-get install telnet > /dev/null 2> /dev/null
    - sudo apt-get install x11-utils > /dev/null 2> /dev/null
    - sudo apt-get install xvkbd > /dev/null 2> /dev/null
    - sudo apt-get install qrencode > /dev/null 2> /dev/null

    - sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 749D6EEC0353B12C
    - sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys F76221572C52609D
    - sudo apt-get update
    - sudo bash -c 'cd /etc/apt/sources.list.d; echo "deb http://old-releases.ubuntu.com/ubuntu/ raring main restricted universe multiverse" >ia32-libs-raring.list'
    - sudo apt-get update
    - sudo apt-get install libncurses-dev
    - sudo apt-get install lib32ncurses5-dev

    - mkdir -p "/home/ubuntu/.sbt/.lib/0.13.12/"
    - wget http://repo.typesafe.com/typesafe/ivy-releases/org.scala-sbt/sbt-launch/0.13.12/sbt-launch.jar -O "/home/ubuntu/.sbt/.lib/0.13.12/sbt-launch.jar"

    - sudo apt-get install libdevel-trace-perl
    #- sudo apt-get install clang-3.5
    - sudo apt-get install clang
    - sudo apt-get install p7zip-full

    #- sudo update-alternatives --install /usr/bin/cc cc /usr/bin/clang 100
    #- sudo update-alternatives --install /usr/bin/c++ c++ /usr/bin/clang++ 100

    - gradle -v # display gradle version
    - echo y | android update sdk --no-ui --all --filter "tools"
    - android list sdk --all | grep -i tools
    - android list sdk --all --extended

    - echo y | android update sdk --no-ui --all --filter build-tools-23.0.3 > /dev/null 2> /dev/null
    - echo y | android update sdk --no-ui --all --filter android-23 > /dev/null 2> /dev/null
    - echo y | android update sdk --no-ui --all --filter platform-tools > /dev/null 2> /dev/null

    - echo y | android update sdk --no-ui --all --filter extra-android-m2repository > /dev/null 2> /dev/null
    - echo y | android update sdk --no-ui --all --filter extra-google-m2repository > /dev/null 2> /dev/null
    - echo y | android update sdk --no-ui --all --filter extra-android-support > /dev/null 2> /dev/null

    - echo y | android update sdk --no-ui --all --filter platform-tools-preview > /dev/null 2> /dev/null
    - echo y | android update sdk --no-ui --all --filter sys-img-armeabi-v7a-android-23 > /dev/null 2> /dev/null
    - echo y | android update sdk --no-ui --all --filter sys-img-armeabi-v7a-addon-google_apis-google-23 > /dev/null 2> /dev/null
    - echo y | android update sdk --no-ui --all --filter addon-google_apis-google-23 > /dev/null 2> /dev/null

# ------- install missing NDK ----------
    - wget -O ~/zandroid-ndk.sh 'https://raw.githubusercontent.com/zoff99/circleCI_android_template/master/android-ndk.sh'
    - printf 'export NDK_VERSION=r10d\n. ~/zandroid-ndk.sh && install_android_ndk\n' | sudo bash
# ------- install missing NDK ----------

    - pwd ; ls -al

    - ./download-dependencies.sh

    - git submodule init
    - git submodule update

# ------ build libsodiumjni.so ------
    - sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys F76221572C52609D
    - sudo apt-get update
    - sudo apt-get install build-essential libtool autotools-dev automake checkinstall check git yasm
    - sudo apt-get install libopus-dev libvpx-dev pkg-config
    - cd libsodium-jni/ ; git submodule init
    - cd libsodium-jni/ ; git submodule update
    - cd libsodium-jni/ ; ./dependencies-linux.sh
    - cd libsodium-jni/ ; ./build.sh
    - cd libsodium-jni/ ; ./build-kaliumjni.sh
    - cd libsodium-jni/ ; ./build-libsodiumjni.sh
    - find ~/ -name 'libsodiumjni.so' -exec ls -al {} \; ; exit 0
    - find ~/ -name 'libsodiumjni.so' -exec file {} \; ; exit 0
    # ---- copy libraries to Antox folder ----
    - cp -v libsodium-jni/libs/armeabi/libsodiumjni.so app/src/main/jniLibs/armeabi/
    #- cp -v libsodium-jni/libs/arm64-v8a/libsodiumjni.so app/src/main/jniLibs/arm64-v8a/
    - mkdir -p app/src/main/jniLibs/armeabi-v7a/    
    - cp -v libsodium-jni/libs/armeabi-v7a/libsodiumjni.so app/src/main/jniLibs/armeabi-v7a/
    - cp -v libsodium-jni/libs/x86/libsodiumjni.so app/src/main/jniLibs/x86/
    #- mkdir -p app/src/main/jniLibs/mips/    
    #- cp -v libsodium-jni/libs/mips/libsodiumjni.so app/src/main/jniLibs/mips/
    # ---- copy libraries to Antox folder ----
# ------ build libsodiumjni.so ------

# ------ build and install toxcore and toxav ----
    - sudo apt-get install build-essential libtool autotools-dev automake checkinstall check git yasm
    - sudo apt-get install libopus-dev libvpx-dev pkg-config
    - mkdir toxcore
    - cd toxcore ; git clone https://github.com/TokTok/c-toxcore.git
    - cd toxcore ; cd c-toxcore ; git checkout 7d2f2e4607080ebf5155b43050c62af4f14b9c88

    ### ------- get libsodium -------
    - cd toxcore ; cd c-toxcore ; mkdir ./libsodium
    - cd toxcore ; cd c-toxcore ; cd ./libsodium/ ; git clone https://github.com/jedisct1/libsodium.git
    - cd toxcore ; cd c-toxcore ; cd ./libsodium/ ; cd libsodium/ ; git checkout tags/1.0.11
    - cd toxcore ; cd c-toxcore ; cd ./libsodium/ ; cd libsodium/ ; ./autogen.sh
    - cd toxcore ; cd c-toxcore ; cd ./libsodium/ ; cd libsodium/ ; ./configure && make check
    - cd toxcore ; cd c-toxcore ; cd ./libsodium/ ; cd libsodium/ ; sudo bash -c "printf 'y\naa\n\n' | checkinstall --install --pkgname libsodium --pkgversion 1.0.0 --nodoc --deldesc=no --pkglicense='GPL2'"
    - cd toxcore ; cd c-toxcore ; cd ./libsodium/ ; cd libsodium/ ; sudo ldconfig
    ### ------- get libsodium -------

##### ------------ BUILD ------------
    - cd toxcore ; cd c-toxcore ; cmake -DWARNINGS=OFF .
    #- cmake .
    - cd toxcore ; cd c-toxcore ; make
    - cd toxcore ; cd c-toxcore ; sudo make install
    - sudo ldconfig
##### ------------ BUILD ------------
# ------ build and install toxcore and toxav ----


# ------ build tox4j stuff ----------
    - sudo apt-get install check libcv-dev libhighgui-dev libopencv-contrib-dev libsndfile1-dev libvpx-dev opam portaudio19-dev texinfo
    - cd jvm-toxcore-c/ ; pwd
    - cd jvm-toxcore-c/ ; git submodule init ; exit 0
    - cd jvm-toxcore-c/ ; git submodule update ; exit 0
    - sudo update-alternatives --install /usr/bin/cc cc /usr/bin/clang 100
    - sudo update-alternatives --install /usr/bin/c++ c++ /usr/bin/clang++ 100
    - cd jvm-toxcore-c/ ; export NDK_HOME=~/android-ndk ; buildscripts/00_dependencies_host ; exit 0
    - cd jvm-toxcore-c/ ; export NDK_HOME=~/android-ndk ; buildscripts/01_ndk ; exit 0
    - cd jvm-toxcore-c/ ; export NDK_HOME=~/android-ndk ; buildscripts/02_toolchain ; exit 0
    - cd jvm-toxcore-c/ ; export NDK_HOME=~/android-ndk ; buildscripts/03_dependencies_target ; exit 0
    - cd jvm-toxcore-c/ ; export NDK_HOME=~/android-ndk ; buildscripts/04_build ; exit 0
    #- cd jvm-toxcore-c/ ; export NDK_HOME=~/android-ndk ; buildscripts/05_android ; exit 0
    #- cd jvm-toxcore-c/ ; make
    # ---- copy jar to Antox folder ----------
    - rm -Rf app/src/main/protobuf/ ; exit 0
    - rm -Rf app/src/main/java/im/ ; exit 0
    - find jvm-toxcore-c/ -name 'tox4j*jar' -exec ls -al {} \; ; exit 0
    - cp -v ./jvm-toxcore-c/target/scala-2.11/tox4j-c_2.11-0.1.0-SNAPSHOT.jar app/libs/tox4j_2.11.jar
    - cp -v ./jvm-toxcore-c/target/scala-2.11/tox4j-c_2.11-0.1.0-SNAPSHOT.jar $CIRCLE_ARTIFACTS/
    # ---- copy jar to Antox folder ----------
    # ---- copy libraries to Antox folder ----
    # cp -av libtox4j.so app/src/main/jniLibs/armeabi/libtox4j.so
    # cp -av libtox4j.so app/src/main/jniLibs/armeabi-v7a/libtox4j.so
    # mkdir -p app/src/main/jniLibs/arm64-v8a
    # cp -av libtox4j.so app/src/main/jniLibs/arm64-v8a/libtox4j.so
    # cp -av libtox4j.so app/src/main/jniLibs/x86/libtox4j.so
    # ---- copy libraries to Antox folder ----
# ------ build tox4j stuff ----------

    - cat app/build.gradle | grep 'useCompileDaemon'
    - sed -i -e 's#scalaCompileOptions.useCompileDaemon = true#scalaCompileOptions.useCompileDaemon = false#' app/build.gradle
    - cat app/build.gradle | grep 'useCompileDaemon'

    - ./gradlew build -x lint; exit 0 # first build will FAIL !!
    - ./gradlew assembleDebug --stacktrace --info --no-daemon ; exit 0 # remove exit 0 later!!
    - ls -al app/build/outputs/apk/ ; exit 0

test:
  pre:
    - mksdcard -l e 180M sdcard.img
    - echo 'mtools_skip_check=1' > ~/.mtoolsrc
    - android list targets
#
    - if [ "$EMU_" == "appemu23" ]; then echo "no" | android create avd -n appemu23 -f -t android-23 --abi default/armeabi-v7a --skin "WXGA720" ; fi
    - if [ "$EMU_" == "appemu23" ]; then cat ~/.android/avd/appemu23.avd/config.ini ; fi
#
    - if [ "$EMU_" == "appemu21" ]; then echo "no" | android create avd -n appemu21 -f -t android-21 --abi default/armeabi-v7a --skin "WXGA720" ; fi
    - if [ "$EMU_" == "appemu21" ]; then cat ~/.android/avd/appemu21.avd/config.ini ; fi
#
    - if [ "$EMU_" == "appemu10" ]; then echo "no" | android create avd -n appemu10 -f -t android-10 --abi default/armeabi --skin "WQVGA432" ; fi
    - if [ "$EMU_" == "appemu10" ]; then cat ~/.android/avd/appemu10.avd/config.ini ; fi
#
    - echo "$EMU_"
    - echo "$sdpath"
  override:
    - emulator -avd "$EMU_" -sdcard sdcard.img -no-audio:
        background: true
        parallel: true
    - circle-android wait-for-boot

    - sleep 210 # let the emulator settle down first

    - adb shell input keyevent 82 # remove lock screen on emulator
    - sleep 10
    - import -window root $CIRCLE_ARTIFACTS/capture_emulator_running.png

    - adb shell "cat /proc/meminfo" ; exit 0

    - adb shell ls -al / ; exit 0
    - adb shell ls -al /storage/ ; exit 0
    - adb shell ls -al /sdcard/ ; exit 0

    - adb install ~/app-signed-aligned.apk

    - adb logcat -v time > $CIRCLE_ARTIFACTS/adb_out.txt 2>&1 :
        background: true
    - sleep 60 # let the emulator settle down first

    - fb-adb shell am start -n $CLASS_P/$START_INTENT_P
    - sleep 60
    - sleep 120 # wait to be sure the app has started fully

    - died_count=`cat $CIRCLE_ARTIFACTS/adb_out.txt|grep 'Process. '"$CLASS_P"', PID.'|wc -l|tr -d ' '` ; if [ $died_count -gt 0 ]; then echo "app crashed"; exit 1; fi

    - import -window root $CIRCLE_ARTIFACTS/capture_app_running.png # get proof that the app is running
    - adb shell screencap -p | sed 's/\r$//' > $CIRCLE_ARTIFACTS/capture_app_running_2.png

